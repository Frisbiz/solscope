<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SolScope - Solana Wallet Intelligence</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap');

  :root {
    --bg:#080b10; --surface:#0d1117; --surf2:#131922; --border:#1c2333; --border2:#243045;
    --accent:#9945ff; --green:#14f195; --red:#f05c5c; --yellow:#ffd166; --orange:#f4845f; --blue:#60a5fa;
    --text:#e2e8f0; --muted:#7a8a9e; --dim:#3d4f63;
    --mono:'Space Mono',monospace; --sans:'DM Sans',sans-serif; --r:8px;
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
  body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
    background:radial-gradient(ellipse 60% 40% at 80% 10%,rgba(153,69,255,.07) 0%,transparent 60%),
               radial-gradient(ellipse 40% 30% at 10% 80%,rgba(20,241,149,.04) 0%,transparent 50%);}
  .wrap{max-width:1400px;margin:0 auto;padding:0 24px;position:relative;z-index:1;}

  /* HEADER */
  header{border-bottom:1px solid var(--border);padding:0;position:sticky;top:0;background:rgba(8,11,16,.95);backdrop-filter:blur(16px);z-index:100;}
  .header-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;height:56px;}
  .logo{font-family:var(--mono);font-size:15px;display:flex;align-items:center;gap:10px;text-decoration:none;}
  .logo-icon{width:30px;height:30px;flex-shrink:0;background:linear-gradient(135deg,var(--accent),var(--green));border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:15px;}
  .logo-text{color:var(--text);} .logo-text em{color:var(--green);font-style:normal;}
  .header-right{display:flex;align-items:center;gap:8px;}
  .status-pill{font-family:var(--mono);font-size:10px;padding:4px 10px;border-radius:20px;border:1px solid var(--border2);color:var(--dim);background:var(--surf2);}
  .status-pill.running{border-color:var(--accent);color:var(--accent);background:rgba(153,69,255,.08);}
  .status-pill.done{border-color:var(--green);color:var(--green);background:rgba(20,241,149,.08);}
  .status-pill.error{border-color:var(--red);color:var(--red);background:rgba(240,92,92,.08);}

  /* BUTTONS */
  .btn{border:none;border-radius:6px;padding:8px 16px;font-family:var(--sans);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;white-space:nowrap;display:inline-flex;align-items:center;gap:6px;}
  .btn-primary{background:var(--accent);color:#fff;} .btn-primary:hover{background:#8535e6;} .btn-primary:disabled{opacity:.5;cursor:not-allowed;}
  .btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--muted);} .btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
  .btn-teal{background:rgba(20,241,149,.1);border:1px solid rgba(20,241,149,.25);color:var(--green);} .btn-teal:hover{background:rgba(20,241,149,.2);}
  .btn-sm{padding:5px 10px;font-size:11px;}

  main{padding:24px 0 60px;}

  /* STATS */
  .stats-row{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:20px;}
  @media(max-width:900px){.stats-row{grid-template-columns:repeat(3,1fr);}}
  .stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;position:relative;overflow:hidden;}
  .stat::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px;}
  .stat.c-purple::before{background:var(--accent);} .stat.c-green::before{background:var(--green);}
  .stat.c-blue::before{background:var(--blue);}     .stat.c-yellow::before{background:var(--yellow);}
  .stat.c-orange::before{background:var(--orange);}
  .stat-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-family:var(--mono);margin-bottom:6px;}
  .stat-val{font-size:20px;font-weight:700;}
  .cv-purple{color:var(--accent);} .cv-green{color:var(--green);} .cv-blue{color:var(--blue);}
  .cv-yellow{color:var(--yellow);} .cv-orange{color:var(--orange);}

  /* SECTION */
  .section{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-top:12px;}
  .section h2{font-size:14px;letter-spacing:.3px;margin-bottom:10px;font-family:var(--mono);color:var(--text);}
  .subnote{font-size:11px;color:var(--muted);margin:8px 0 0;line-height:1.4;}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}

  /* INPUTS */
  .fi{background:var(--surf2);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:11px;padding:5px 9px;outline:none;font-family:var(--mono);transition:border-color .2s;}
  .fi::placeholder{color:var(--dim);} .fi:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(153,69,255,.1);}
  .fi-xs{width:52px;} .fi-sm{width:70px;} .fi-md{width:90px;} .fi-lg{width:200px;}
  .sel{background:var(--surf2);border:1px solid var(--border);border-radius:5px;color:var(--muted);font-size:11px;padding:5px 9px;outline:none;cursor:pointer;font-family:var(--mono);transition:border-color .2s;}
  .sel:focus{border-color:var(--accent);}

  /* SCRAPE CONFIG */
  .scrape-config{display:flex;align-items:center;gap:10px;flex-wrap:wrap;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px 16px;margin-bottom:12px;}
  .cfg-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-family:var(--mono);}
  .cfg-sep{width:1px;height:18px;background:var(--border);margin:0 6px;}
  .cb-label{font-size:11px;color:var(--text);display:flex;align-items:center;gap:6px;}
  input[type="checkbox"]{accent-color:var(--accent);}

  /* TABS */
  .tabs{display:flex;gap:8px;margin:14px 0 12px;}
  .tab{flex:0 0 auto;background:transparent;border:1px solid var(--border2);color:var(--muted);padding:7px 12px;border-radius:7px;font-size:12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:8px;}
  .tab:hover{border-color:var(--accent);color:var(--accent);}
  .tab.active{background:rgba(153,69,255,.12);border-color:var(--accent);color:var(--accent);}
  .tab-badge{font-family:var(--mono);font-size:10px;border:1px solid var(--border2);padding:1px 8px;border-radius:14px;color:var(--muted);}
  .tab-badge.orange{border-color:rgba(244,132,95,.35);color:var(--orange);}
  .tab-badge.blue{border-color:rgba(96,165,250,.35);color:var(--blue);}
  .tab-pane{display:none;}
  .tab-pane.active{display:block;}

  /* LOG PANEL */
  .log-panel{display:none;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;margin-bottom:10px;font-family:var(--mono);font-size:11px;color:var(--muted);max-height:160px;overflow:auto;line-height:1.5;}
  .log-ok{color:var(--green);} .log-err{color:var(--red);} .log-inf{color:var(--blue);}

  /* PROGRESS */
  .progress-bar-wrap{display:none;height:6px;border-radius:99px;background:rgba(36,48,69,.5);overflow:hidden;margin-bottom:14px;}
  .progress-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--accent),var(--green));width:0%;transition:width .2s;}

  /* TABLE */
  table{width:100%;border-collapse:separate;border-spacing:0;}
  th,td{padding:10px 10px;border-bottom:1px solid var(--border);font-size:12px;vertical-align:middle;}
  th{font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);cursor:pointer;user-select:none;white-space:nowrap;}
  tr:hover td{background:rgba(19,25,34,.55);}
  .mono{font-family:var(--mono);}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 9px;border-radius:99px;font-size:11px;font-family:var(--mono);border:1px solid var(--border2);color:var(--muted);background:rgba(19,25,34,.6);}
  .pill.green{border-color:rgba(20,241,149,.25);color:var(--green);background:rgba(20,241,149,.08);}
  .pill.red{border-color:rgba(240,92,92,.25);color:var(--red);background:rgba(240,92,92,.08);}
  .pill.blue{border-color:rgba(96,165,250,.25);color:var(--blue);background:rgba(96,165,250,.08);}
  .tag{font-size:10px;padding:3px 7px;border-radius:6px;border:1px solid var(--border2);font-family:var(--mono);color:var(--muted);display:inline-block;}
  .tag.whale{border-color:rgba(20,241,149,.28);color:var(--green);background:rgba(20,241,149,.06);}
  .tag.smart{border-color:rgba(153,69,255,.28);color:var(--accent);background:rgba(153,69,255,.06);}
  .tag.bot{border-color:rgba(244,132,95,.28);color:var(--orange);background:rgba(244,132,95,.06);}
  .actions{display:flex;gap:6px;justify-content:flex-end;}
  .right{text-align:right;}
  .muted{color:var(--muted);}
  .dim{color:var(--dim);}
  .nowrap{white-space:nowrap;}

  /* TRENDING */
  .trend-note{font-size:11px;color:var(--muted);margin-top:10px;line-height:1.45;}
  .trend-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;}
  @media(max-width:900px){.trend-grid{grid-template-columns:1fr;}}
  .trend-card{background:var(--surf2);border:1px solid var(--border);border-radius:var(--r);padding:12px;}
  .trend-addr{font-family:var(--mono);font-size:12px;color:var(--text);}
  .trend-meta{font-size:10px;color:var(--muted);margin-top:6px;display:flex;justify-content:space-between;gap:10px;}
  .trend-actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;}

  /* CA LOOKUP */
  .ca-banner{display:none;margin:10px 0 0;background:rgba(96,165,250,.08);border:1px solid rgba(96,165,250,.22);color:var(--blue);padding:10px 12px;border-radius:var(--r);font-size:11px;font-family:var(--mono);}
  .ca-banner.err{background:rgba(240,92,92,.08);border-color:rgba(240,92,92,.22);color:var(--red);}
  .ca-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px;}
  @media(max-width:900px){.ca-grid{grid-template-columns:1fr;}}
  .ca-card{background:var(--surf2);border:1px solid var(--border);border-radius:var(--r);padding:14px;}
  .ca-title{display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .ca-ca{font-family:var(--mono);font-size:12px;color:var(--text);}
  .ca-addr{font-family:var(--mono);font-size:11px;color:var(--muted);margin-top:8px;word-break:break-all;}
  .ca-stats{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;}
  .mini{font-size:10px;color:var(--muted);font-family:var(--mono);}

  /* TOAST */
  .toast{position:fixed;right:22px;bottom:22px;background:rgba(13,17,23,.96);border:1px solid var(--border);color:var(--text);
         padding:10px 12px;border-radius:10px;font-size:12px;box-shadow:0 12px 35px rgba(0,0,0,.45);opacity:0;transform:translateY(12px);
         transition:opacity .25s, transform .25s;z-index:999;}
  .toast.show{opacity:1;transform:translateY(0);}

  /* MISC */
  .help{font-size:11px;color:var(--muted);line-height:1.45;margin-top:12px;}
  .sep{height:1px;background:var(--border);margin:14px 0;}
  .btn-icon{width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center;border-radius:5px;border:1px solid var(--border2);color:var(--muted);}
  .btn-icon:hover{border-color:var(--accent);color:var(--accent);}
  .danger{color:var(--red);}

  @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  .spinning{display:inline-block;animation:spin 1s linear infinite;}

  /* PERIOD TABS (1D / 7D / 30D) */
  .period-tabs{display:flex;gap:8px;margin:12px 0 14px;}
  .period-btn{background:var(--surface);border:1px solid var(--border2);color:var(--muted);padding:6px 14px;border-radius:6px;font-family:var(--mono);font-size:11px;cursor:pointer;transition:all .15s;}
  .period-btn:hover{border-color:var(--accent);color:var(--accent);}
  .period-btn.active{background:rgba(153,69,255,.15);border-color:var(--accent);color:var(--accent);}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="header-inner">
      <a class="logo" href="#">
        <div class="logo-icon">‚óé</div>
        <span class="logo-text">Sol<em>Scope</em></span>
      </a>
      <div class="header-right">
        <span class="status-pill" id="statusPill">‚óé Idle</span>
        <button class="btn btn-primary" id="scrapeBtn" onclick="startScrape()">‚ñ∂ Auto-Discover</button>
      </div>
    </div>
  </div>
</header>

<main>
<div class="wrap">

  <!-- Stats (smart money only - trending & CA never affect this) -->
  <div class="stats-row">
    <div class="stat c-purple"><div class="stat-label">Wallets Tracked</div><div class="stat-val cv-purple" id="s-count">0</div></div>
    <div class="stat c-green"> <div class="stat-label">Profitable</div>     <div class="stat-val cv-green"  id="s-prof">0</div></div>
    <div class="stat c-blue">  <div class="stat-label">Whales</div>         <div class="stat-val cv-blue"   id="s-whale">0</div></div>
    <div class="stat c-yellow"><div class="stat-label">Avg Win Rate</div>   <div class="stat-val cv-yellow" id="s-wr">-</div></div>
    <div class="stat c-orange"><div class="stat-label">Total PnL</div>      <div class="stat-val cv-orange" id="s-pnl">-</div></div>
    <div class="stat c-orange"><div class="stat-label">Shown / Total</div> <div class="stat-val cv-orange"  id="s-shown">-</div></div>
  </div>

  <!-- Period (Smart Money stats) -->
  <div class="period-tabs" id="periodTabs">
    <button class="period-btn" data-period="1d">1D</button>
    <button class="period-btn active" data-period="7d">7D</button>
    <button class="period-btn" data-period="30d">30D</button>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('smart')"    id="tab-smart">üß† Smart Money <span class="tab-badge" id="tb-smart">0</span></button>
    <button class="tab"        onclick="switchTab('trending')" id="tab-trending">üî• Trending <span class="tab-badge orange" id="tb-trending">0</span></button>
    <button class="tab"        onclick="switchTab('ca')"       id="tab-ca">üîç CA Lookup <span class="tab-badge blue" id="tb-ca">0</span></button>
  </div>

  <!-- Shared log + progress -->
  <div class="log-panel" id="logPanel"></div>
  <div class="progress-bar-wrap" id="progressWrap"><div class="progress-bar-fill" id="progressFill" style="width:0%"></div></div>

  <!-- ‚ïê‚ïê SMART MONEY ‚ïê‚ïê -->
  <div class="tab-pane active" id="pane-smart">
    <div class="scrape-config">
      <span class="cfg-label">Sources</span>
      <label class="cb-label"><input type="checkbox" id="cfgGmgn" checked> GMGN Leaderboards</label>
      <label class="cb-label"><input type="checkbox" id="cfgTrending" checked> Trending Buyers</label>
      <div class="cfg-sep"></div>
      <span class="cfg-label">Min Threshold</span>
      <span style="font-size:11px;color:var(--muted)">WR</span>
      <input class="fi fi-xs" id="cfgMinWr" value="0" />
      <span style="font-size:11px;color:var(--muted)">%</span>
      <span style="font-size:11px;color:var(--muted)">PnL</span>
      <input class="fi fi-md" id="cfgMinPnl" value="0" />
      <span style="font-size:11px;color:var(--muted)">Trades</span>
      <input class="fi fi-sm" id="cfgMinTrades" value="0" />
      <div class="cfg-sep"></div>

      <span class="cfg-label">Filter</span>
      <select class="sel" id="f-tag" onchange="applyFilters()">
        <option value="all">All Tags</option>
        <option value="whale">Whale</option>
        <option value="smart">Smart</option>
        <option value="bot">Bot</option>
        <option value="none">No Tag</option>
      </select>

      <span class="cfg-label">Sort</span>
      <select class="sel" id="f-sort" onchange="setSort(this.value)">
        <option value="pnl">PnL</option>
        <option value="winrate">Win Rate</option>
        <option value="trades">Trades</option>
        <option value="hold">Hold</option>
        <option value="active">Active</option>
      </select>

      <button class="btn btn-ghost btn-sm" onclick="toggleSortDir()">‚áÖ</button>

      <div style="flex:1"></div>
      <button class="btn btn-ghost btn-sm" onclick="exportJSON()">Export</button>
      <button class="btn btn-ghost btn-sm" onclick="importJSON()">Import</button>
      <button class="btn btn-ghost btn-sm danger" onclick="clearAll()">Clear</button>
    </div>

    <div class="section">
      <h2>Tracked Wallets</h2>

      <div class="row" style="justify-content:space-between;margin-bottom:10px;">
        <div class="row">
          <input class="fi fi-lg" id="q" placeholder="Search address..." oninput="applyFilters()">
          <button class="btn btn-ghost btn-sm" onclick="applyFilters()">Search</button>
        </div>

        <div class="row">
          <span class="pill">Sort: <span class="mono" id="sortLabel">PnL</span></span>
          <span class="pill">Dir: <span class="mono" id="dirLabel">DESC</span></span>
          <span class="pill">Shown: <span class="mono" id="shownLabel">0</span></span>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th onclick="setSort('tag')">Tag</th>
            <th class="mono">Address</th>
            <th class="right" onclick="setSort('pnl')">PnL</th>
            <th class="right" onclick="setSort('winrate')">Win Rate</th>
            <th class="right" onclick="setSort('hold')">Avg Hold</th>
            <th class="right" onclick="setSort('trades')">Trades</th>
            <th class="right" onclick="setSort('active')">Last Active</th>
            <th class="right">Actions</th>
          </tr>
        </thead>
        <tbody id="walletBody"></tbody>
      </table>

      <div class="help">
        Notes:
        <div class="subnote">- Smart Money wallets store full stats (PnL + WR + trades + hold). Period tabs re-fetch walletNew per wallet for the selected window.</div>
        <div class="subnote">- Trending list stores addresses only. Use "Track" to add a trending wallet to Smart Money tracking.</div>
        <div class="subnote">- CA Lookup is per-session and does not persist. It uses the same period selection as Smart Money.</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê TRENDING ‚ïê‚ïê -->
  <div class="tab-pane" id="pane-trending">
    <div class="section">
      <h2>Trending Buyers (address only)</h2>
      <div class="row" style="margin-bottom:10px;">
        <button class="btn btn-primary" onclick="refreshTrending()">‚Üª Refresh Trending</button>
        <button class="btn btn-ghost" onclick="clearTrending()">Clear</button>
      </div>
      <div class="trend-grid" id="trendGrid"></div>
      <div class="trend-note">
        Trending wallets are fetched from GMGN "trending buyers" endpoint. These are addresses only.
        If you want full stats, click "Track" on a card.
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê CA LOOKUP ‚ïê‚ïê -->
  <div class="tab-pane" id="pane-ca">
    <div class="section">
      <h2>CA Lookup</h2>
      <div class="row">
        <input class="fi fi-lg" id="caIn" placeholder="Paste token CA(s), space/newline separated" />
        <button class="btn btn-primary" id="caBtn" onclick="fetchCA()">Fetch Traders</button>
        <button class="btn btn-ghost" onclick="clearCA()">Clear</button>
      </div>
      <div class="ca-banner" id="caBanner"></div>
      <div class="ca-grid" id="caGrid"></div>
      <div class="help">
        <div class="subnote">Tip: paste multiple token contract addresses (CAs). SolScope will pull top traders / holders then map to wallets.</div>
        <div class="subnote">Some wallets are not indexed as "smart money" by GMGN. Those can return PnL + trades but null win rate and hold.</div>
      </div>
    </div>
  </div>

</div>
</main>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SolScope  -  three separate data stores, never mixed
//   wallets[]   ‚Üí Smart Money  (full stats, persisted)
//   trending[]  ‚Üí Trending     (addresses only, persisted)
//   caWallets[] ‚Üí CA Lookup    (per-session)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let wallets   = [];
let trending  = [];
let caWallets = [];
let filtered  = [];
let sortField = 'pnl';
let sortAsc   = false;
let scraping  = false;
let currentPeriod = '7d';
let periodRefreshing = false;

// ‚îÄ‚îÄ Persist ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function save()         { try { localStorage.setItem('ss11',  JSON.stringify(wallets));  } catch(e){} }
function saveTrending() { try { localStorage.setItem('ss11t', JSON.stringify(trending)); } catch(e){} }
function load() {
  try { const d=localStorage.getItem('ss11');  if(d) wallets  = JSON.parse(d); } catch(e){}
  try { const d=localStorage.getItem('ss11t'); if(d) trending = JSON.parse(d); } catch(e){}
}
const sleep = ms => new Promise(r=>setTimeout(r,ms));

const PROXY = window.location.hostname==='localhost' ? 'http://localhost:8080' : window.location.origin;

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStatus(text, cls='') {
  const el = document.getElementById('statusPill');
  el.className = 'status-pill ' + (cls||'');
  el.textContent = text || '‚óé Idle';
}
function setProgress(pct) {
  const wrap = document.getElementById('progressWrap');
  const fill = document.getElementById('progressFill');
  if (pct==null) { wrap.style.display='none'; return; }
  wrap.style.display='block';
  fill.style.width = Math.max(0,Math.min(100,pct)) + '%';
  if (pct>=100) setTimeout(()=>{wrap.style.display='none';},700);
}
function log(msg, kind='') {
  const p = document.getElementById('logPanel');
  p.style.display='block';
  const div=document.createElement('div');
  div.className = kind==='ok'?'log-ok':kind==='err'?'log-err':kind==='inf'?'log-inf':'';
  div.textContent = msg;
  p.appendChild(div);
  p.scrollTop = p.scrollHeight;
}
function toast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1800);
}
function parseFloatSafe(x){ const n=parseFloat(x); return Number.isFinite(n)?n:null; }

// ‚îÄ‚îÄ Proxy Fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pf(url) {
  const r = await fetch(PROXY + '/proxy?' + encodeURIComponent(url));
  if (!r.ok) throw new Error('proxy ' + r.status);
  const j = await r.json();
  if (j.error) throw new Error(j.error);
  return j;
}

// ‚îÄ‚îÄ Wallet Model ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mkWallet(addr, pnl, winrate, holdMins, trades, source) {
  return {
    address: addr,
    pnl: pnl ?? null,
    winrate: winrate ?? null,
    holdMins: holdMins ?? null,
    trades: trades ?? null,
    source: source || 'gmgn',
    tag: (pnl??0)>50000?'whale' : (winrate??0)>0.65?'smart' : (trades??0)>300?'bot' : '',
    hasStats: pnl != null,
    lastActive: Date.now()
  };
}

// ‚îÄ‚îÄ Parse leaderboard entries ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseEntry(w, period) {
  const addr = w?.wallet_address || w?.address || w?.addr;
  if (!addr) return null;
  const pnl = parseFloatSafe(w?.[`realized_profit_${period}`] ?? w?.realized_profit ?? w?.pnl);
  const winrate = parseFloatSafe(w?.winrate ?? w?.wr);
  const holdMins = w?.avg_holding_peroid != null ? Math.round(parseFloatSafe(w.avg_holding_peroid)/60) : null;
  const trades = (parseInt(w?.[`buy_${period}`] ?? w?.buy ?? 0)) + (parseInt(w?.[`sell_${period}`] ?? w?.sell ?? 0));
  return { addr, pnl: pnl ?? 0, winrate: winrate ?? 0, holdMins, trades: trades ?? 0 };
}

// ‚îÄ‚îÄ UI Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(name) {
  ['smart','trending','ca'].forEach(t=>{
    document.getElementById('pane-'+t).classList.toggle('active', t===name);
    document.getElementById('tab-'+t).classList.toggle('active', t===name);
  });
}

// ‚îÄ‚îÄ Sorting ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSort(field) {
  sortField = field;
  document.getElementById('f-sort').value = field==='hold'?'hold':field==='active'?'active':field==='winrate'?'winrate':field==='trades'?'trades':'pnl';
  applyFilters();
}
function toggleSortDir() { sortAsc=!sortAsc; applyFilters(); }

// ‚îÄ‚îÄ Stats badges ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function badges() {
  document.getElementById('tb-smart').textContent = wallets.length;
  document.getElementById('tb-trending').textContent = trending.length;
  document.getElementById('tb-ca').textContent = caWallets.length;

  document.getElementById('s-count').textContent = wallets.length.toLocaleString();
  const prof = wallets.filter(w => (w.pnl??0) > 0).length;
  const whales = wallets.filter(w => w.tag==='whale').length;
  const wrs = wallets.filter(w => w.winrate!=null).map(w => w.winrate);
  const avgWr = wrs.length ? (wrs.reduce((a,b)=>a+b,0)/wrs.length) : null;
  const pnlTot = wallets.filter(w=>w.pnl!=null).reduce((a,b)=>a+(b.pnl||0),0);

  document.getElementById('s-prof').textContent = prof.toLocaleString();
  document.getElementById('s-whale').textContent = whales.toLocaleString();
  document.getElementById('s-wr').textContent = avgWr==null ? '-' : Math.round(avgWr*100)+'%';
  document.getElementById('s-pnl').textContent = pnlTot==0 ? '-' : '$'+Math.round(pnlTot).toLocaleString();

  document.getElementById('s-shown').textContent = `${filtered.length.toLocaleString()} / ${wallets.length.toLocaleString()}`;
  document.getElementById('shownLabel').textContent = filtered.length.toLocaleString();

  document.getElementById('sortLabel').textContent =
    sortField==='pnl'?'PnL':sortField==='winrate'?'WinRate':sortField==='trades'?'Trades':sortField==='hold'?'Hold':sortField==='active'?'Active':'Tag';
  document.getElementById('dirLabel').textContent = sortAsc?'ASC':'DESC';
}

// ‚îÄ‚îÄ Filter + render Smart Money ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyFilters() {
  const q = (document.getElementById('q').value || '').trim().toLowerCase();
  const tag = document.getElementById('f-tag').value;

  filtered = wallets.filter(w=>{
    if (q && !w.address.toLowerCase().includes(q)) return false;
    if (tag==='all') return true;
    if (tag==='none') return !w.tag;
    return w.tag===tag;
  });

  const get = (w) => {
    if (sortField==='pnl') return w.pnl ?? -Infinity;
    if (sortField==='winrate') return w.winrate ?? -Infinity;
    if (sortField==='trades') return w.trades ?? -Infinity;
    if (sortField==='hold') return w.holdMins ?? -Infinity;
    if (sortField==='active') return w.lastActive ?? 0;
    if (sortField==='tag') return (w.tag||'').charCodeAt(0)||0;
    return 0;
  };

  filtered.sort((a,b)=>{
    const va=get(a), vb=get(b);
    const d = (va>vb?1:va<vb?-1:0);
    return sortAsc ? d : -d;
  });

  renderWallets();
  badges();
}

function renderWallets() {
  const body = document.getElementById('walletBody');
  body.innerHTML='';
  for (const w of filtered) {
    const tr=document.createElement('tr');

    const tdTag=document.createElement('td');
    tdTag.innerHTML = w.tag ? `<span class="tag ${w.tag}">${w.tag}</span>` : `<span class="dim">-</span>`;
    tr.appendChild(tdTag);

    const tdAddr=document.createElement('td');
    tdAddr.className='mono nowrap';
    tdAddr.innerHTML = `<span title="${w.address}">${w.address.slice(0,4)}...${w.address.slice(-4)}</span> <span class="btn-icon" title="Copy" onclick="cp('${w.address}')">‚éò</span>`;
    tr.appendChild(tdAddr);

    const tdPnl=document.createElement('td');
    tdPnl.className='right mono';
    tdPnl.innerHTML = w.pnl==null ? `<span class="dim">-</span>` : `<span class="${w.pnl>=0?'cv-green':'cv-red'}">$${Math.round(w.pnl).toLocaleString()}</span>`;
    tr.appendChild(tdPnl);

    const tdWr=document.createElement('td');
    tdWr.className='right mono';
    tdWr.innerHTML = w.winrate==null ? `<span class="dim">-</span>` : `${Math.round(w.winrate*100)}%`;
    tr.appendChild(tdWr);

    const tdHold=document.createElement('td');
    tdHold.className='right mono';
    tdHold.innerHTML = w.holdMins==null ? `<span class="dim">-</span>` : fmtHold(w.holdMins).v;
    tr.appendChild(tdHold);

    const tdTr=document.createElement('td');
    tdTr.className='right mono';
    tdTr.innerHTML = w.trades==null ? `<span class="dim">-</span>` : w.trades.toLocaleString();
    tr.appendChild(tdTr);

    const tdAct=document.createElement('td');
    tdAct.className='right mono';
    tdAct.innerHTML = w.lastActive ? fmtDate(w.lastActive) : `<span class="dim">-</span>`;
    tr.appendChild(tdAct);

    const tdA=document.createElement('td');
    tdA.className='right';
    tdA.innerHTML = `
      <div class="actions">
        <button class="btn btn-ghost btn-sm" onclick="openGMGN('${w.address}')">GMGN</button>
        <button class="btn btn-ghost btn-sm" onclick="removeWallet('${w.address}')">Remove</button>
      </div>`;
    tr.appendChild(tdA);

    body.appendChild(tr);
  }
}

function openGMGN(addr) {
  window.open(`https://gmgn.ai/sol/address/${addr}`, '_blank');
}

function removeWallet(addr) {
  wallets = wallets.filter(w => w.address !== addr);
  save();
  applyFilters();
  toast('Removed');
}

function clearAll() {
  if (!confirm('Clear all saved smart money wallets?')) return;
  wallets=[];
  save();
  applyFilters();
  toast('Cleared');
}

// ‚îÄ‚îÄ Export/Import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportJSON() {
  const blob=new Blob([JSON.stringify(wallets,null,2)], {type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='solscope-wallets.json';
  a.click();
  toast('Exported');
}
function importJSON() {
  const inp=document.createElement('input');
  inp.type='file'; inp.accept='application/json';
  inp.onchange=async () => {
    const f=inp.files[0]; if(!f) return;
    const txt=await f.text();
    try {
      const arr=JSON.parse(txt);
      if (!Array.isArray(arr)) throw new Error('not array');
      const seen=new Set(wallets.map(w=>w.address));
      for (const w of arr) if (w?.address && !seen.has(w.address)) wallets.push(w);
      save(); applyFilters(); badges();
      toast('Imported');
    } catch(e) { alert('Import failed: '+e.message); }
  };
  inp.click();
}

// ‚îÄ‚îÄ Trending ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function scrapeTrendingWallets(seen) {
  let added=0;
  log('[Trending] Fetching buyers‚Ä¶');
  const d = await pf('https://gmgn.ai/defi/quotation/v1/trending/buyers/sol?limit=80');
  const list = d.data?.list || d.list || [];
  for (const it of list) {
    const addr = it?.address || it?.wallet || it?.wallet_address;
    if (!addr || seen.has(addr)) continue;
    seen.add(addr);
    trending.unshift({ address: addr, ts: Date.now() });
    added++;
  }
  saveTrending();
  renderTrending();
  log(`[Trending] Added ${added} addresses`,'ok');
  return added;
}

async function refreshTrending() {
  try {
    setStatus('Trending‚Ä¶','running'); setProgress(5);
    const seen=new Set(trending.map(w=>w.address));
    const a=await scrapeTrendingWallets(seen);
    setStatus('Done','done'); setProgress(100);
    toast(`Trending +${a}`);
  } catch(e) {
    setStatus('Error','error');
    log('[Trending] '+e.message,'err');
  }
}

function renderTrending() {
  const grid=document.getElementById('trendGrid');
  grid.innerHTML='';
  for (const t of trending) {
    const div=document.createElement('div');
    div.className='trend-card';
    div.innerHTML = `
      <div class="trend-addr">${t.address.slice(0,4)}...${t.address.slice(-4)}</div>
      <div class="trend-meta"><span>${fmtDate(t.ts)}</span><span class="mono">addr</span></div>
      <div class="trend-actions">
        <button class="btn btn-teal btn-sm" onclick="trackFromTrending('${t.address}')">Track</button>
        <button class="btn btn-ghost btn-sm" onclick="openGMGN('${t.address}')">GMGN</button>
        <button class="btn btn-ghost btn-sm" onclick="removeTrending('${t.address}')">Remove</button>
      </div>`;
    grid.appendChild(div);
  }
  badges();
}

function removeTrending(addr) {
  trending = trending.filter(w => w.address !== addr);
  saveTrending();
  renderTrending();
  toast('Removed');
}

function clearTrending() {
  if (!confirm('Clear trending list?')) return;
  trending=[];
  saveTrending();
  renderTrending();
  toast('Cleared');
}

async function trackFromTrending(addr) {
  if (wallets.some(w=>w.address===addr)) { toast('Already tracked'); return; }
  try {
    setStatus('Tracking‚Ä¶','running');
    const d = await pf(`https://gmgn.ai/defi/quotation/v1/smartmoney/sol/walletNew/${addr}?period=${currentPeriod}`);
    const w = d.data;
    if (!w || typeof w !== 'object') throw new Error('no data');

    const key = `realized_profit_${currentPeriod}`;
    const buyKey = `buy_${currentPeriod}`;
    const sellKey = `sell_${currentPeriod}`;

    const pnl = w[key] != null ? parseFloatSafe(w[key]) : parseFloatSafe(w.realized_profit);
    const winrate = parseFloatSafe(w.winrate);
    const holdMins = w.avg_holding_peroid != null ? Math.round(parseFloatSafe(w.avg_holding_peroid)/60) : null;
    const trades = (parseInt(w[buyKey] ?? w.buy ?? 0)) + (parseInt(w[sellKey] ?? w.sell ?? 0));

    wallets.unshift(mkWallet(addr, pnl, winrate, holdMins, trades, 'trending'));
    save();
    applyFilters();
    badges();
    setStatus('Done','done');
    toast('Tracked');
  } catch(e) {
    setStatus('Error','error');
    log('[Track] '+e.message,'err');
  }
}

// ‚îÄ‚îÄ Scrape leaderboards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function scrapeLeaderboards(minWr, minPnl, minTrades, seen) {
  const eps = [
    {url:'https://gmgn.ai/defi/quotation/v1/rank/sol/wallets/1d?orderby=pnl&direction=desc&limit=200',     label:'1d PnL',     period:'1d'},
    {url:'https://gmgn.ai/defi/quotation/v1/rank/sol/wallets/1d?orderby=winrate&direction=desc&limit=200', label:'1d WinRate', period:'1d'},
    {url:'https://gmgn.ai/defi/quotation/v1/rank/sol/wallets/7d?orderby=pnl&direction=desc&limit=200',     label:'7d PnL',     period:'7d'},
    {url:'https://gmgn.ai/defi/quotation/v1/rank/sol/wallets/7d?orderby=winrate&direction=desc&limit=200', label:'7d WinRate', period:'7d'},
    {url:'https://gmgn.ai/defi/quotation/v1/rank/sol/wallets/30d?orderby=pnl&direction=desc&limit=200',    label:'30d PnL',    period:'30d'},
    {url:'https://gmgn.ai/defi/quotation/v1/rank/sol/wallets/30d?orderby=winrate&direction=desc&limit=200',label:'30d WinRate',period:'30d'},
  ];
  let added = 0;
  for (let i=0; i<eps.length; i++) {
    const {url,label,period} = eps[i];
    try {
      log(`[Leaderboard] ${label}‚Ä¶`);
      const d = await pf(url);
      const list = d.data?.rank || d.rank || [];
      log(`[Leaderboard] ${label} - ${list.length} entries`);
      for (const w of list) {
        const s = parseEntry(w, period);
        if (!s || seen.has(s.addr)) continue;
        if (s.winrate < minWr || s.pnl < minPnl || s.trades < minTrades) continue;
        seen.add(s.addr);
        wallets.unshift(mkWallet(s.addr, s.pnl, s.winrate, s.holdMins, s.trades, 'gmgn'));
        added++;
        log(`  ‚úì ${s.addr.slice(0,8)}‚Ä¶ $${Math.round(s.pnl).toLocaleString()} ${Math.round(s.winrate*100)}%WR`, 'ok');
      }
    } catch(e) {
      log(`[Leaderboard] ${label} failed: ${e.message}`, 'err');
    }
    setProgress(Math.round(((i+1)/eps.length)*45)+5);
    await sleep(400);
  }
  return added;
}

// ‚îÄ‚îÄ Main scrape orchestrator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startScrape() {
  if (scraping) return;
  scraping = true;
  const btn = document.getElementById('scrapeBtn');
  btn.disabled=true; btn.textContent='‚ü≥ Running‚Ä¶';
  document.getElementById('logPanel').innerHTML='';
  document.getElementById('logPanel').style.display='block';
  setStatus('Scraping‚Ä¶','running'); setProgress(2);

  const minWr     = (parseFloat(document.getElementById('cfgMinWr').value)    ||0)/100;
  const minPnl    =  parseFloat(document.getElementById('cfgMinPnl').value)   ||0;
  const minTrades =  parseInt(document.getElementById('cfgMinTrades').value)  ||0;
  const useGmgn   = document.getElementById('cfgGmgn').checked;
  const useTrend  = document.getElementById('cfgTrending').checked;

  try {
    let lb=0, tr=0;
    if (useGmgn) { const seen=new Set(wallets.map(w=>w.address)); lb=await scrapeLeaderboards(minWr,minPnl,minTrades,seen); }
    if (useTrend){ const seen=new Set(trending.map(w=>w.address)); tr=await scrapeTrendingWallets(seen); }
    save(); applyFilters(); setProgress(100); badges();
    setStatus(`Done - ${lb} smart + ${tr} trending`,'done');
    log(`‚úì ${lb} smart money + ${tr} trending addresses`,'inf');
    toast(`‚úì ${lb} smart money wallets added`);
  } catch(e) { setStatus('Error','error'); log('Fatal: '+e.message,'err'); }

  scraping=false; btn.disabled=false; btn.textContent='‚ñ∂ Auto-Discover';
}

// ‚îÄ‚îÄ CA Lookup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchCA() {
  const btn=document.getElementById('caBtn');
  const banner=document.getElementById('caBanner');
  const raw=(document.getElementById('caIn').value||'').trim();
  if(!raw){toast('Paste CA(s) first');return;}
  btn.disabled=true; btn.textContent='‚ü≥ Fetching‚Ä¶';
  banner.style.display='none';
  caWallets=[];
  renderCA(); badges();

  try {
    setStatus('CA lookup‚Ä¶','running'); setProgress(4);
    const cas=[...new Set(raw.split(/\s+/g).filter(Boolean))].slice(0,30);
    log(`[CA] ${cas.length} token(s)‚Ä¶`,'inf');

    // For each CA, pull top traders list, then map to wallet stats
    let withStats=0;
    for (let ci=0; ci<cas.length; ci++) {
      const ca = cas[ci];
      log(`[CA] token ${ci+1}/${cas.length}: ${ca.slice(0,6)}‚Ä¶`,'inf');
      // gmgn "token traders" endpoint
      const td = await pf(`https://gmgn.ai/defi/quotation/v1/tokens/top_traders/sol/${ca}?limit=10`);
      const traders = td.data?.list || td.list || [];
      for (let i=0; i<traders.length; i++) {
        const addr = traders[i]?.address || traders[i]?.wallet_address || traders[i]?.wallet;
        if (!addr) continue;
        // Use null sentinels so we can distinguish "GMGN returned null" from "no data"
        const entry = {address:addr, tokenCa:ca, source:'ca', pnl:null, winrate:null, holdMins:null, trades:null, tag:'', hasStats:false, lastActive:Date.now()};
        try {
          // walletNew returns data for any wallet - period is controlled by tabs
          const sd = await pf(`https://gmgn.ai/defi/quotation/v1/smartmoney/sol/walletNew/${addr}?period=${currentPeriod}`);
          const w = sd.data;
          if (w && typeof w === 'object') {
            const key = `realized_profit_${currentPeriod}`;
            const buyKey = `buy_${currentPeriod}`;
            const sellKey = `sell_${currentPeriod}`;

            const pnl = w[key] != null ? parseFloat(w[key])
                      : w.realized_profit     != null ? parseFloat(w.realized_profit) : null;
            // Winrate & hold: GMGN only computes these for "smart money" indexed wallets - null otherwise
            const winrate  = w.winrate != null ? parseFloat(w.winrate) : null;
            const holdMins = w.avg_holding_peroid != null ? Math.round(parseFloat(w.avg_holding_peroid) / 60) : null;
            // Trades: use period counts
            const trades = (parseInt(w[buyKey] ?? w.buy ?? 0)) + (parseInt(w[sellKey] ?? w.sell ?? 0));
            entry.pnl      = pnl;
            entry.winrate  = winrate;
            entry.holdMins = holdMins;
            entry.trades   = trades || null;
            entry.hasStats = pnl !== null;
            entry.tag = (pnl??0)>50000?'whale' : (winrate??0)>0.65?'smart' : (trades??0)>300?'bot' : '';
            if (entry.hasStats) withStats++;
          }
        } catch(_) {}
        caWallets.push(entry);
        if ((i+1)%5===0) { renderCA(); badges(); }
        await sleep(300);
      }
      setProgress(Math.round(((ci+1)/cas.length)*100));
      await sleep(500);
    }

    const withFull    = caWallets.filter(w=>w.hasStats && w.winrate!==null).length;
    const withPartial = caWallets.filter(w=>w.hasStats && w.winrate===null).length;
    const addrOnly    = caWallets.filter(w=>!w.hasStats).length;
    banner.className='ca-banner';
    banner.textContent=`‚úì ${caWallets.length} wallets ¬∑ ${withFull} full stats ¬∑ ${withPartial} PnL+trades only ¬∑ ${addrOnly} address-only`;
    banner.style.display='block';
    renderCA(); badges();
    log(`[CA] Done - ${caWallets.length} wallets, ${withStats} with stats`,'ok');

  } catch(e) {
    banner.className='ca-banner err';
    banner.textContent='Error: '+e.message+' - is server.py running?';
    banner.style.display='block';
    log(`[CA] failed: ${e.message}`,'err');
  }
  btn.disabled=false; btn.textContent='Fetch Traders';
  setStatus('Done','done'); setProgress(100);
}

function clearCA() {
  caWallets=[];
  document.getElementById('caIn').value='';
  document.getElementById('caBanner').style.display='none';
  renderCA(); badges();
  toast('Cleared');
}

function renderCA() {
  const grid=document.getElementById('caGrid');
  grid.innerHTML='';
  for (const w of caWallets) {
    const div=document.createElement('div');
    div.className='ca-card';
    const pnl = w.pnl==null ? '-' : '$'+Math.round(w.pnl).toLocaleString();
    const wr  = w.winrate==null ? '-' : Math.round(w.winrate*100)+'%';
    const hold= w.holdMins==null ? '-' : fmtHold(w.holdMins).v;
    const tr  = w.trades==null ? '-' : w.trades.toLocaleString();
    div.innerHTML = `
      <div class="ca-title">
        <div class="ca-ca">${w.tokenCa.slice(0,6)}...${w.tokenCa.slice(-4)}</div>
        ${w.tag?`<span class="tag ${w.tag}">${w.tag}</span>`:`<span class="mini dim">no tag</span>`}
      </div>
      <div class="ca-addr">${w.address}</div>
      <div class="ca-stats">
        <span class="pill ${w.pnl!=null && w.pnl>=0?'green':'red'}">PnL: <span class="mono">${pnl}</span></span>
        <span class="pill blue">WR: <span class="mono">${wr}</span></span>
        <span class="pill">Hold: <span class="mono">${hold}</span></span>
        <span class="pill">Trades: <span class="mono">${tr}</span></span>
      </div>
      <div class="trend-actions" style="margin-top:12px;">
        <button class="btn btn-ghost btn-sm" onclick="openGMGN('${w.address}')">GMGN</button>
        <button class="btn btn-teal btn-sm" onclick="trackFromCA('${w.address}')">Track</button>
        <button class="btn btn-ghost btn-sm" onclick="cp('${w.address}')">Copy</button>
      </div>`;
    grid.appendChild(div);
  }
}

async function trackFromCA(addr) {
  if (wallets.some(w=>w.address===addr)) { toast('Already tracked'); return; }
  try {
    setStatus('Tracking‚Ä¶','running');
    const d = await pf(`https://gmgn.ai/defi/quotation/v1/smartmoney/sol/walletNew/${addr}?period=${currentPeriod}`);
    const w = d.data;
    if (!w || typeof w !== 'object') throw new Error('no data');

    const key = `realized_profit_${currentPeriod}`;
    const buyKey = `buy_${currentPeriod}`;
    const sellKey = `sell_${currentPeriod}`;

    const pnl = w[key] != null ? parseFloatSafe(w[key]) : parseFloatSafe(w.realized_profit);
    const winrate = parseFloatSafe(w.winrate);
    const holdMins = w.avg_holding_peroid != null ? Math.round(parseFloatSafe(w.avg_holding_peroid)/60) : null;
    const trades = (parseInt(w[buyKey] ?? w.buy ?? 0)) + (parseInt(w[sellKey] ?? w.sell ?? 0));

    wallets.unshift(mkWallet(addr, pnl, winrate, holdMins, trades, 'ca'));
    save();
    applyFilters();
    badges();
    setStatus('Done','done');
    toast('Tracked');
  } catch(e) {
    setStatus('Error','error');
    log('[Track] '+e.message,'err');
  }
}

// ‚îÄ‚îÄ Period tabs (1d / 7d / 30d) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setPeriod(p) {
  currentPeriod = p;
  const btns = document.querySelectorAll('.period-btn');
  btns.forEach(b => b.classList.toggle('active', b.dataset.period === p));
  // Refresh smart money stats for this period so every wallet is comparable
  refreshSmartMoneyStats();
}

async function refreshSmartMoneyStats() {
  if (periodRefreshing) return;
  if (!wallets || wallets.length === 0) return;

  periodRefreshing = true;
  try {
    setStatus(`Refreshing ${currentPeriod}‚Ä¶`, 'running');
    setProgress(2);

    // Throttled sequential refresh to avoid rate-limits / Cloudflare
    for (let i = 0; i < wallets.length; i++) {
      const w = wallets[i];
      try {
        const sd = await pf(`https://gmgn.ai/defi/quotation/v1/smartmoney/sol/walletNew/${w.address}?period=${currentPeriod}`);
        const d = sd.data;

        if (d && typeof d === 'object') {
          const key = `realized_profit_${currentPeriod}`;
          const buyKey  = `buy_${currentPeriod}`;
          const sellKey = `sell_${currentPeriod}`;

          const pnl = d[key] != null ? parseFloat(d[key])
                    : d.realized_profit != null ? parseFloat(d.realized_profit) : null;

          const winrate  = d.winrate != null ? parseFloat(d.winrate) : null;
          const holdMins = d.avg_holding_peroid != null ? Math.round(parseFloat(d.avg_holding_peroid) / 60) : null;
          const trades   = (parseInt(d[buyKey] ?? d.buy ?? 0)) + (parseInt(d[sellKey] ?? d.sell ?? 0));

          w.pnl      = pnl;
          w.winrate  = winrate;
          w.holdMins = holdMins;
          w.trades   = trades || null;
          w.hasStats = pnl !== null;
          w.tag      = (pnl ?? 0) > 50000 ? 'whale' : (winrate ?? 0) > 0.65 ? 'smart' : (trades ?? 0) > 300 ? 'bot' : '';
          w.lastActive = Date.now();
        } else {
          w.hasStats = false;
        }
      } catch (_) {
        // keep prior values if refresh fails for this wallet
      }

      if ((i + 1) % 6 === 0) {
        save();
        applyFilters();
        badges();
        setProgress(Math.round(((i + 1) / wallets.length) * 100));
        await sleep(250);
      } else {
        await sleep(150);
      }
    }

    save();
    applyFilters();
    badges();
    setProgress(100);
    setStatus(`Done - ${currentPeriod}`, 'done');
    log(`‚úì Refreshed ${wallets.length} wallets for ${currentPeriod}`, 'ok');
  } catch (e) {
    setStatus('Error', 'error');
    log('Period refresh failed: ' + e.message, 'err');
  } finally {
    periodRefreshing = false;
    // Let the pill settle back after a moment
    setTimeout(() => { if (!scraping) setStatus('‚óé Idle'); }, 800);
  }
}

// ‚îÄ‚îÄ Formatting ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtHold(m) {
  if(!m||m<1)return{v:'-',u:''};
  if(m<60)  return{v:m+'m',u:'minutes'};
  if(m<1440)return{v:(m/60).toFixed(1)+'h',u:'hours'};
  return         {v:(m/1440).toFixed(1)+'d',u:'days'};
}
function fmtDate(ts){const d=(Date.now()-ts)/86400000;if(d<1)return'today';if(d<2)return'1d ago';return Math.floor(d)+'d ago';}
function esc(s){return s.replace(/[<>&"]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c]));}
function cp(addr){navigator.clipboard.writeText(addr).catch(()=>{});toast('Copied '+addr.slice(0,8)+'‚Ä¶');}

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
['solscope3','solscope4','solscope5','solscope6','solscope7','solscope8','solscope9','solscope10','solscope11'].forEach(k=>localStorage.removeItem(k));
load(); applyFilters(); renderTrending(); badges();

// Period tabs init
try {
  document.querySelectorAll('.period-btn').forEach(b => b.addEventListener('click', () => setPeriod(b.dataset.period)));
  // Ensure default matches button state
  setPeriod(document.querySelector('.period-btn.active')?.dataset.period || '7d');
} catch (_) {}
</script>

</body>
</html>
